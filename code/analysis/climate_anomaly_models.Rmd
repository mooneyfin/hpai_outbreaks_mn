---
title: "climate_anomaly_model_tests"
author: "Fintan Mooney"
date: "2025-10-16"
output: html_document
---


```{r setup, include=FALSE}
 
knitr::opts_chunk$set(echo = TRUE)
 
# ---- Package setup ----
packages <- c(
  "MatchIt", "readr", "sf", "survival", "dlnm", "gtsummary", "kableExtra",
  "tidyr", "tibble", "mgcv", "ggplot2", "car", "patchwork", "corrplot",
  "purrr", "ggspatial", "gt", "flextable", "officer", "conflicted",
  "dplyr", "data.table", "here", "viridis", "ggeffects", "broom", "gratia"
)


installed <- packages %in% rownames(installed.packages())
if (any(!installed)) install.packages(packages[!installed])

invisible(lapply(packages, library, character.only = TRUE))

# Resolve conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

# Project folders (e.g., where the .Rproj file is)
base_folder <- here()
data_folder <- here("data")
env_folder <- here("data", "EarthEngine_MN")
objects_folder <-here("data", "objects")
figures_folder <-here("output", "figures")
tables_folder <-here("output", "tables")

```


## Read in timeseries df

```{r, read in timeseries df}

# Timeseries
fishnet_timeseries_clean <- readRDS(file.path(objects_folder, "fishnet_timeseries.RDS"))
```

```{r, arrange df}

timeseries_clean <- fishnet_timeseries_clean %>%
  arrange(zone_id, week)

```

## Log and Scale Bird Abundance

```{r, log and scale bird abundance}

timeseries_clean <- timeseries_clean %>%
  mutate(log_bird_abundance = scale(log1p(total_bird_abundance)))


```

## Run Models

```{r, run models}

# Climate Anomalies Relative to 25yr Mean

model_25yr <- bam(
  outbreak_binary ~
    season +
   # log_bird_abundance +
    s(precipitation_z_25yr, k = 12) +
    s(snow_density_z_25yr, k = 20) +   
    s(runoff_z_25yr, k = 25) +         
    s(soil_moisture_z_25yr, k = 8) +
    s(wind_speed_z_25yr, k = 5) +
    s(temperature_z_25yr, k = 25) +    
    s(lat, lon, bs = "ds", k = 200),   
  family   = nb(),
  data     = timeseries_clean,
  method   = "fREML",
  discrete = TRUE
)
gam.check(model_25yr)
summary(model_25yr)$s.table



# Climate Anomalies Relative to 10yr Mean


model_10yr <- bam(
  outbreak_binary ~
    season +
   # log_bird_abundance +
    s(precipitation_z_10yr, k = 12) +
    s(snow_density_z_10yr, k = 20) +   
    s(runoff_z_10yr, k = 25) +         
    s(soil_moisture_z_10yr, k = 8) +
    s(wind_speed_z_10yr, k = 5) +
    s(temperature_z_10yr, k = 25) +    
    s(lat, lon, bs = "ds", k = 200),  
  family   = nb(),
  data     = timeseries_clean,
  method   = "fREML",
  discrete = TRUE
)
gam.check(model_10yr)
summary(model_10yr)$s.table

```

## Plot partial effects of temperature anomalies on HPAI outbreak risk

```{r, draw temp partial effects}

## 25-yr Temperature Anomaly
draw(model_25yr, select = "s(temperature_z_25yr)", residuals = TRUE)

## 10-yr Temperature Anomaly
draw(model_10yr, select = "s(temperature_z_10yr)", residuals = TRUE)

# Professional Plot

# Build smooth draws
p_temp25 <- gratia::draw(model_25yr, select = "s(temperature_z_25yr)", residuals = TRUE) +
  ggplot2::coord_cartesian(ylim = c(-2, 6)) +
  ggplot2::labs(
    title = "25-Year Baseline (1997–2021)",
    x = "Temperature Anomaly (z-score)",
    y = "Partial effect"
  ) +
  ggplot2::theme_bw(base_size = 12) +
  ggplot2::theme(
    panel.grid = ggplot2::element_blank(),
    panel.border = ggplot2::element_rect(color = "black", fill = NA),
    plot.title  = ggplot2::element_text(face = "bold", size = 12),
    axis.title  = ggplot2::element_text(size = 10)
  )

p_temp10 <- gratia::draw(model_10yr, select = "s(temperature_z_10yr)", residuals = TRUE) +
  ggplot2::coord_cartesian(ylim = c(-2, 6)) +
  ggplot2::labs(
    title = "10-Year Baseline (2012–2021)",
    x = "Temperature Anomaly (z-score)",
    y = "Partial effect"
  ) +
  ggplot2::theme_bw(base_size = 12) +
  ggplot2::theme(
    panel.grid = ggplot2::element_blank(),
    panel.border = ggplot2::element_rect(color = "black", fill = NA),
    plot.title  = ggplot2::element_text(face = "bold", size = 12),
    axis.title  = ggplot2::element_text(size = 10)
  )

# Combine with annotation
fig_temp_compare <- patchwork::wrap_plots(p_temp25, p_temp10, ncol = 2) +
  patchwork::plot_annotation(
    title = "Temperature Anomalies and Relative Outbreak Risk Under Different Baseline Windows",
    theme = ggplot2::theme(
      plot.title   = ggplot2::element_text(size = 14, face = "bold"),
      plot.caption = ggplot2::element_text(size = 9, hjust = 0)
    )
  )

# Export to your figures folder
ggplot2::ggsave(
  filename = file.path(figures_folder, "figure_temperature_anomaly_25yr10yr_comparision.png"),
  plot     = fig_temp_compare,
  width    = 9,
  height   = 4.5,
  dpi      = 600
)
```

## Plot All Effects from 25yr Model

```{r, 25yr plot}
# ============================================================
# HPAI Outbreak Risk Model —  Nonlinear Anomalies + Season + Spatial
# ============================================================

# Confirm model object

summary(model_25yr)
gam.check(model_25yr)

# Publication theme

theme_pub <- ggplot2::theme_bw(base_size = 12) +
  ggplot2::theme(
    panel.grid    = ggplot2::element_blank(),
    panel.border  = ggplot2::element_rect(color = "black", fill = NA, linewidth = 0.4),
    plot.title    = ggplot2::element_text(face = "bold", size = 12),
    axis.title    = ggplot2::element_text(size = 10),
    strip.text    = ggplot2::element_text(face = "bold"),
    plot.caption  = ggplot2::element_text(size = 9, hjust = 0)
  )

# Nonlinear anomaly smooths

pred_vars <- c(
  "s(precipitation_z_25yr)",
  "s(snow_density_z_25yr)",
  "s(runoff_z_25yr)",
  "s(soil_moisture_z_25yr)",
  "s(wind_speed_z_25yr)",
  "s(temperature_z_25yr)"
)

pretty_titles <- c(
  "Precipitation","Snow Density","Runoff",
  "Soil Moisture","Wind Speed","Temperature"
)

smooth_plots <- lapply(seq_along(pred_vars), function(i) {
  v <- pred_vars[i]
  eff <- gratia::smooth_estimates(model_25yr, select = v) |>
    dplyr::mutate(
      fitted = exp(.data$.estimate),
      lower  = exp(.data$.estimate - 2 * .data$.se),
      upper  = exp(.data$.estimate + 2 * .data$.se)
    )

  x_col <- setdiff(
    names(eff),
    c(".smooth",".type",".by",".estimate",".se","fitted","lower","upper")
  )[1]

  ggplot2::ggplot(eff, ggplot2::aes(x = .data[[x_col]], y = fitted)) +
    ggplot2::geom_ribbon(ggplot2::aes(ymin = lower, ymax = upper),
                         fill = "grey70", alpha = 0.3) +
    ggplot2::geom_line(linewidth = 0.8, color = "black") +
    ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
    ggplot2::coord_cartesian(xlim = c(-2, 2), ylim = c(-5, 15)) +
    ggplot2::scale_y_continuous(
      breaks = seq(-5, 15, by = 5),
      labels = function(x) ifelse(x %% 1 == 0, as.character(as.integer(x)), as.character(x))
    ) +
    ggplot2::labs(
      title = pretty_titles[i],
      x = "Anomaly (z-score)",
      y = "Relative risk"
    ) +
    theme_pub +
    ggplot2::theme(
      axis.text.y = ggplot2::element_text(size = 8)
    )
})

panel_anomalies <- patchwork::wrap_plots(smooth_plots, ncol = 3) +
  patchwork::plot_annotation(
    title = "Nonlinear Relative Risk of HPAI Outbreaks vs Environmental Anomalies",
    theme = ggplot2::theme(plot.title = ggplot2::element_text(size = 12, face = "bold"))
  )


# Spatial smooth with contour + fishnet overlay

eff_spatial <- gratia::smooth_estimates(model_25yr, select = "s(lat,lon)") |>
  dplyr::mutate(rr = exp(.data$.estimate))

fishnet_path <- file.path(data_folder, "HPAIfishnet_zone_dissolved_10km.shp")
fishnet_sf   <- sf::st_read(fishnet_path, quiet = TRUE) |>
  sf::st_transform(4326)

p_spatial <- ggplot2::ggplot() +
  ggplot2::geom_raster(
    data = eff_spatial,
    ggplot2::aes(x = lon, y = lat, fill = rr),
    interpolate = TRUE
  ) +
  ggplot2::geom_contour(
    data = eff_spatial,
    ggplot2::aes(x = lon, y = lat, z = rr),
    color = "white", linewidth = 0.2, alpha = 0.6, bins = 10
  ) +
  ggplot2::geom_sf(
    data = fishnet_sf,
    fill = NA,
    color = "grey85",
    linewidth = 0.15
  ) +
  ggplot2::scale_fill_viridis_c(name = "Relative risk", option = "E") +
  ggplot2::coord_sf(expand = FALSE) +
  ggplot2::labs(
    title = "Spatial Smooth: Baseline Relative Risk of HPAI Outbreaks",
    x = "Longitude", y = "Latitude"
  ) +
  theme_pub

# Seasonal fixed effects

season_effects <- broom::tidy(model_25yr, parametric = TRUE) |>
  dplyr::filter(grepl("^season", .data$term)) |>
  dplyr::mutate(
    RR    = exp(.data$estimate),
    lower = exp(.data$estimate - 2 * .data$std.error),
    upper = exp(.data$estimate + 2 * .data$std.error),
    Season = gsub("^season", "", .data$term)
  ) |>
  dplyr::mutate(
    Season = factor(Season, levels = c("Fall","Spring","Summer"))
  )

p_season <- ggplot2::ggplot(season_effects, ggplot2::aes(x = Season, y = RR)) +
  ggplot2::geom_col(fill = "steelblue") +
  ggplot2::geom_errorbar(ggplot2::aes(ymin = lower, ymax = upper), width = 0.2) +
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
  ggplot2::coord_cartesian(ylim = c(0, 30)) +
  ggplot2::scale_y_continuous(
    breaks = seq(0, 30, by = 5),
    labels = function(x) ifelse(x %% 1 == 0, as.character(as.integer(x)), as.character(x))
  ) +
  ggplot2::labs(
    title = "Seasonal Baseline Effects on HPAI Outbreak Risk",
    x = "Season",
    y = "Relative risk vs Winter"
  ) +
  theme_pub +
  ggplot2::theme(
    axis.text.y = ggplot2::element_text(size = 8)
  )


# Final multi-panel figure

final_panel_25yr <-
  (panel_anomalies /
   (p_spatial | p_season)) +
  patchwork::plot_annotation(
    caption = "Negative-binomial GAM: The association between climate anomalies in 2022 (compared to 25yr mean) on HPAI outbreak risk in commercial and backyard farms.",
    theme = ggplot2::theme(plot.caption = ggplot2::element_text(size = 9, hjust = 0))
  )

final_panel_25yr


```



## 10-yr Anomalies Timeseries

```{r, 10yr model}

model_10yr <- bam(
  outbreak_binary ~
    season +
   # log_bird_abundance +
    s(precipitation_z_10yr, k = 12) +
    s(snow_density_z_10yr, k = 20) +   # keep 20
    s(runoff_z_10yr, k = 25) +         # small bump
    s(soil_moisture_z_10yr, k = 8) +
    s(wind_speed_z_10yr, k = 5) +
    s(temperature_z_10yr, k = 25) +    # small bump
    s(lat, lon, bs = "ds", k = 200),   # optional bump for smoothness
  family   = nb(),
  data     = timeseries_clean,
  method   = "fREML",
  discrete = TRUE
)

summary(model_10yr)
gam.check(model_10yr)
```
## Plot All Effects from 10yr Model


```{r, 10yr plot}
# ============================================================
# HPAI Outbreak Risk Model —  Nonlinear Anomalies + Season + Spatial
# ============================================================

# Publication theme

theme_pub <- ggplot2::theme_bw(base_size = 12) +
  ggplot2::theme(
    panel.grid    = ggplot2::element_blank(),
    panel.border  = ggplot2::element_rect(color = "black", fill = NA, linewidth = 0.4),
    plot.title    = ggplot2::element_text(face = "bold", size = 12),
    axis.title    = ggplot2::element_text(size = 10),
    strip.text    = ggplot2::element_text(face = "bold"),
    plot.caption  = ggplot2::element_text(size = 9, hjust = 0)
  )

# Nonlinear anomaly smooths

pred_vars <- c(
  "s(precipitation_z_10yr)",
  "s(snow_density_z_10yr)",
  "s(runoff_z_10yr)",
  "s(soil_moisture_z_10yr)",
  "s(wind_speed_z_10yr)",
  "s(temperature_z_10yr)"
)

pretty_titles <- c(
  "Precipitation","Snow Density","Runoff",
  "Soil Moisture","Wind Speed","Temperature"
)

smooth_plots <- lapply(seq_along(pred_vars), function(i) {
  v <- pred_vars[i]
  eff <- gratia::smooth_estimates(model_10yr, select = v) |>
    dplyr::mutate(
      fitted = exp(.data$.estimate),
      lower  = exp(.data$.estimate - 2 * .data$.se),
      upper  = exp(.data$.estimate + 2 * .data$.se)
    )

  x_col <- setdiff(
    names(eff),
    c(".smooth",".type",".by",".estimate",".se","fitted","lower","upper")
  )[1]

  ggplot2::ggplot(eff, ggplot2::aes(x = .data[[x_col]], y = fitted)) +
    ggplot2::geom_ribbon(ggplot2::aes(ymin = lower, ymax = upper),
                         fill = "grey70", alpha = 0.3) +
    ggplot2::geom_line(linewidth = 0.8, color = "black") +
    ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
    ggplot2::coord_cartesian(xlim = c(-2, 2), ylim = c(-5, 15)) +
    ggplot2::scale_y_continuous(
      breaks = seq(-5, 15, by = 5),
      labels = function(x) ifelse(x %% 1 == 0, as.character(as.integer(x)), as.character(x))
    ) +
    ggplot2::labs(
      title = pretty_titles[i],
      x = "Anomaly (z-score)",
      y = "Relative risk"
    ) +
    theme_pub +
    ggplot2::theme(
      axis.text.y = ggplot2::element_text(size = 8)
    )
})

panel_anomalies <- patchwork::wrap_plots(smooth_plots, ncol = 3) +
  patchwork::plot_annotation(
    title = "Nonlinear Relative Risk of HPAI Outbreaks vs Environmental Anomalies",
    theme = ggplot2::theme(plot.title = ggplot2::element_text(size = 12, face = "bold"))
  )


# Spatial smooth with contour + fishnet overlay

eff_spatial <- gratia::smooth_estimates(model_10yr, select = "s(lat,lon)") |>
  dplyr::mutate(rr = exp(.data$.estimate))

fishnet_path <- file.path(data_folder, "HPAIfishnet_zone_dissolved_10km.shp")
fishnet_sf   <- sf::st_read(fishnet_path, quiet = TRUE) |>
  sf::st_transform(4326)

p_spatial <- ggplot2::ggplot() +
  ggplot2::geom_raster(
    data = eff_spatial,
    ggplot2::aes(x = lon, y = lat, fill = rr),
    interpolate = TRUE
  ) +
  ggplot2::geom_contour(
    data = eff_spatial,
    ggplot2::aes(x = lon, y = lat, z = rr),
    color = "white", linewidth = 0.2, alpha = 0.6, bins = 10
  ) +
  ggplot2::geom_sf(
    data = fishnet_sf,
    fill = NA,
    color = "grey85",
    linewidth = 0.15
  ) +
  ggplot2::scale_fill_viridis_c(name = "Relative risk", option = "E") +
  ggplot2::coord_sf(expand = FALSE) +
  ggplot2::labs(
    title = "Spatial Smooth: Baseline Relative Risk of HPAI Outbreaks",
    x = "Longitude", y = "Latitude"
  ) +
  theme_pub

# Seasonal fixed effects

season_effects <- broom::tidy(model_10yr, parametric = TRUE) |>
  dplyr::filter(grepl("^season", .data$term)) |>
  dplyr::mutate(
    RR    = exp(.data$estimate),
    lower = exp(.data$estimate - 2 * .data$std.error),
    upper = exp(.data$estimate + 2 * .data$std.error),
    Season = gsub("^season", "", .data$term)
  ) |>
  dplyr::mutate(
    Season = factor(Season, levels = c("Fall","Spring","Summer"))
  )

p_season <- ggplot2::ggplot(season_effects, ggplot2::aes(x = Season, y = RR)) +
  ggplot2::geom_col(fill = "steelblue") +
  ggplot2::geom_errorbar(ggplot2::aes(ymin = lower, ymax = upper), width = 0.2) +
  ggplot2::geom_hline(yintercept = 1, linetype = "dashed") +
  ggplot2::coord_cartesian(ylim = c(0, 30)) +
  ggplot2::scale_y_continuous(
    breaks = seq(0, 30, by = 5),
    labels = function(x) ifelse(x %% 1 == 0, as.character(as.integer(x)), as.character(x))
  ) +
  ggplot2::labs(
    title = "Seasonal Baseline Effects on HPAI Outbreak Risk",
    x = "Season",
    y = "Relative risk vs Winter"
  ) +
  theme_pub +
  ggplot2::theme(
    axis.text.y = ggplot2::element_text(size = 8)
  )


# Final multi-panel figure

final_panel_10yr <-
  (panel_anomalies /
   (p_spatial | p_season)) +
  patchwork::plot_annotation(
    caption = "Negative-binomial GAM: The association between climate anomalies in 2022 (compared to 10yr mean) on HPAI outbreak risk in commercial and backyard farms.",
    theme = ggplot2::theme(plot.caption = ggplot2::element_text(size = 9, hjust = 0))
  )

final_panel_10yr


```


## Export Panels

```{r, export panels}

# ---- 25-year baseline figure ----
ggplot2::ggsave(
  filename = file.path(figures_folder, "figure_25yr_climate_anomaly_model.png"),
  plot     = final_panel_25yr,
  width    = 11,     # inches
  height   = 8,      # inches
  dpi      = 600
)

# ---- 10-year baseline figure ----
ggplot2::ggsave(
  filename = file.path(figures_folder, "figure_10yr_climate_anomaly_model.png"),
  plot     = final_panel_10yr,
  width    = 11,
  height   = 8,
  dpi      = 600
)


message("Figures successfully exported to: ", figures_folder)



```






