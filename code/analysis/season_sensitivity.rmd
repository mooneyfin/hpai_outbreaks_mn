---
title: "casecrossover_model"
author: "Fintan Mooney"
date: "2025-10-07"
output: html_document
---
# This R markdown file uses a casecrossover study design to model the association between meterological conditons, climate, and wild bird abundance, on risk of highly pathogenic avian influenza (HPAI) outbreaks in Minnesota farms during 2022

## Here we are running a sensitivity analysis to model seasonal effects

```{r setup, include=FALSE}
 
knitr::opts_chunk$set(echo = TRUE)
 
# ---- Package setup ----
packages <- c(
  "MatchIt", "readr", "sf", "survival", "dlnm", "gtsummary", "kableExtra",
  "tidyr", "tibble", "mgcv", "ggplot2", "car", "patchwork", "corrplot",
  "purrr", "ggspatial", "gt", "flextable", "officer", "conflicted",
  "dplyr", "data.table", "here"
)

installed <- packages %in% rownames(installed.packages())
if (any(!installed)) install.packages(packages[!installed])

invisible(lapply(packages, library, character.only = TRUE))

# Resolve conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

# Project folders (e.g., where the .Rproj file is)
base_folder <- here()
data_folder <- here("data")
env_folder <- here("data", "EarthEngine_MN")
objects_folder <-here("data", "objects")
figures_folder <-here("output", "figures")
tables_folder <-here("output", "tables")

list.files(here())

```

## Import casecrossover df

```{r, import casecrossover df}

case_crossover_df <- readRDS(file.path(objects_folder, "case_crossover_df.RDS"))

```

## Investigate distribution of outbreaks by season

```{r, investigate distribution of outbreaks by season}

# Outbreak counts by month with adjusted seasonal vertical lines


# Summarize total outbreaks per month
outbreak_by_month <- case_crossover_df |>
  dplyr::group_by(month) |>
  dplyr::summarise(outbreaks = sum(outbreak_binary, na.rm = TRUE)) |>
  # Ensure all 12 months are represented
  dplyr::right_join(tibble(month = 1:12), by = "month") |>
  dplyr::mutate(outbreaks = dplyr::coalesce(outbreaks, 0))

# Define vertical line positions 
season_markers <- data.frame(
  month = c(3, 6, 9, 12) - 0.5,  # shift lines back by 0.5 month
  season = c("Spring", "Summer", "Fall", "Winter")
)

# Build plot
p_outbreaks_month <- ggplot(outbreak_by_month, aes(x = month, y = outbreaks)) +
  # Bars
  geom_col(fill = "grey50", color = "black", width = 0.8) +

  # Numeric labels above bars
  geom_text(aes(label = outbreaks),
            vjust = -0.3, size = 3.3, fontface = "bold") +

  # Red vertical dashed lines for seasons
  geom_vline(
    data = season_markers,
    aes(xintercept = month),
    color = "red3",
    linetype = "dashed",
    linewidth = 0.6
  ) +

  # Vertical rotated season labels
  geom_text(
    data = season_markers,
    aes(x = month, y = max(outbreak_by_month$outbreaks) * 1.05, label = season),
    color = "red4",
    angle = 90,
    vjust = 1.5,
    hjust = 1,
    size = 3.5,
    fontface = "bold"
  ) +

  # Axes and labels
  scale_x_continuous(
    breaks = 1:12,
    labels = month.abb,
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.1))
  ) +
  labs(
    title = "Monthly Distribution of HPAI Outbreaks",
    x = "Month",
    y = "Number of Outbreaks"
  ) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(face = "bold", size = 13),
    axis.title = element_text(size = 11),
    axis.text.x = element_text(size = 9)
  )

# Save

# PNG version
ggsave(
  filename = file.path(figures_folder, "figure_outbreaks_by_month.png"),
  plot = p_outbreaks_month,
  width = 8, height = 5, dpi = 600
)
```

## As there are a little number of outbreaks in the summer and winter, we will only stratify by spring and fall

```{r, import time series df}



```




## Split the datasets

```{r, split into fall and spring}

# Create a simplified two-season dataset
case_crossover_df_season <- case_crossover_df |>
  dplyr::filter(month %in% c(3,4,5,9,10,11)) 

# Split the dataset
case_crossover_df_season$season_spring <- ifelse(case_crossover_df_season$season == "Spring", 1, 0)
case_crossover_df_season$season_fall   <- ifelse(case_crossover_df_season$season == "Fall", 1, 0)

```



## Crossbasis Terms

```{r, finalized crossbasis}

# ============================================================
# Create unified crossbasis (shared across Spring and Fall)
# ============================================================

make_cb <- function(df, var_prefix, lag_max = 4,
                    argvar_fun = "lin", arglag_fun = "ns", arglag_df = 2) {
  crossbasis(
    x = as.matrix(df[, paste0(var_prefix, "_Lag", 0:lag_max)]),
    lag = c(0, lag_max),
    argvar = list(fun = argvar_fun),
    arglag = list(fun = arglag_fun, df = arglag_df)
  )
}

# Build on the full filtered dataset
cb_runoff              <- make_cb(case_crossover_df_season, "runoff")
cb_snow_density        <- make_cb(case_crossover_df_season, "snow_density")
cb_soil_moisture       <- make_cb(case_crossover_df_season, "soil_moisture")
cb_temperature         <- make_cb(case_crossover_df_season, "temperature")
cb_precipitation       <- make_cb(case_crossover_df_season, "precipitation")
cb_wind_speed          <- make_cb(case_crossover_df_season, "wind_speed")
cb_total_bird_abundance<- make_cb(case_crossover_df_season, "total_bird_abundance")



```

## Model

```{r, interaction model}
# ============================================================
# Fit two-season interaction DLNM case-crossover model
# ============================================================

season_model <- clogit(
  outbreak_binary ~ 
    (cb_runoff + cb_snow_density + cb_soil_moisture + cb_temperature +
     cb_precipitation + cb_wind_speed + cb_total_bird_abundance) * season_spring +
    strata(stratum_id),
  data = case_crossover_df_season,
  method = "efron"
)



```

## Case-Crossover Models

```{r, casecrossover models}

# ----------------------------
# Model Fitting
# ----------------------------
spring_model <- clogit(
  outbreak_binary ~ 
    cb_runoff_spring + cb_snow_density_spring + cb_soil_moisture_spring + cb_temperature_spring +
    cb_precipitation_spring + cb_wind_speed_spring + cb_total_bird_abundance_spring +
    strata(stratum_id),
  method = "efron",
  data = spring_df
)

summary(spring_model)
AIC(spring_model)
saveRDS(spring_model, file.path(objects_folder, "spring_casecrossover_model.RDS"))

fall_model <- clogit(
  outbreak_binary ~ 
    cb_runoff_fall + cb_snow_density_fall + cb_soil_moisture_fall + cb_temperature_fall +
    cb_precipitation_fall + cb_wind_speed_fall + cb_total_bird_abundance_fall +
    strata(stratum_id),
  method = "efron",
  data = fall_df
)

summary(fall_model)
AIC(fall_model)
saveRDS(fall_model, file.path(objects_folder, "fall_casecrossover_model.RDS"))

```

## Spring Model Results

```{r, spring crosspred objects}
# ----------------------------
# Crosspred Objects
# ----------------------------
cp_spring_runoff       <- crosspred(cb_runoff_spring, spring_model, cen = 0, at = 0.5, cumul = TRUE)
cp_spring_snow         <- crosspred(cb_snow_density_spring, spring_model, cen = 0, at = 0.5, cumul = TRUE)
cp_spring_soil         <- crosspred(cb_soil_moisture_spring, spring_model, cen = 0, at = 0.5, cumul = TRUE)
cp_spring_temp         <- crosspred(cb_temperature_spring, spring_model, cen = 0, at = 0.5, cumul = TRUE)
cp_spring_precip       <- crosspred(cb_precipitation_spring, spring_model, cen = 0, at = 0.5, cumul = TRUE)
cp_spring_wind         <- crosspred(cb_wind_speed_spring, spring_model, cen = 0, at = 0.5, cumul = TRUE)
cp_spring_bird         <- crosspred(cb_total_bird_abundance_spring, spring_model, cen = 0, at = 0.5, cumul = TRUE)

cp_spring_slice_runoff <- crosspred(cb_runoff_spring, spring_model, cen = 0, at = 0.5)
cp_spring_slice_snow   <- crosspred(cb_snow_density_spring, spring_model, cen = 0, at = 0.5)
cp_spring_slice_soil   <- crosspred(cb_soil_moisture_spring, spring_model, cen = 0, at = 0.5)
cp_spring_slice_temp   <- crosspred(cb_temperature_spring, spring_model, cen = 0, at = 0.5)
cp_spring_slice_precip <- crosspred(cb_precipitation_spring, spring_model, cen = 0, at = 0.5)
cp_spring_slice_wind   <- crosspred(cb_wind_speed_spring, spring_model, cen = 0, at = 0.5)
cp_spring_slice_bird   <- crosspred(cb_total_bird_abundance_spring, spring_model, cen = 0, at = 0.5)

```

## Casecrossover Plots
```{r, plots casecrossover}
# ----------------------------
# Cumulative OR Summary Table
# ----------------------------
cumulative_summary <- tibble(
  Predictor = c("Surface Runoff", "Snow Density", "Soil Moisture", "Temperature",
                "Precipitation", "Wind Speed", "Total Bird Abundance"),
      OR = c(
        cp_spring_runoff$allRRfit["0.5"],
        cp_spring_snow$allRRfit["0.5"],
        cp_spring_soil$allRRfit["0.5"],
        cp_spring_temp$allRRfit["0.5"],
        cp_spring_precip$allRRfit["0.5"],
        cp_spring_wind$allRRfit["0.5"],
        cp_spring_bird$allRRfit["0.5"]
      ),
      CI_low = c(
        cp_spring_runoff$allRRlow["0.5"],
        cp_spring_snow$allRRlow["0.5"],
        cp_spring_soil$allRRlow["0.5"],
        cp_spring_temp$allRRlow["0.5"],
        cp_spring_precip$allRRlow["0.5"],
        cp_spring_wind$allRRlow["0.5"],
        cp_spring_bird$allRRlow["0.5"]
      ),
      CI_high = c(
        cp_spring_runoff$allRRhigh["0.5"],
        cp_spring_snow$allRRhigh["0.5"],
        cp_spring_soil$allRRhigh["0.5"],
        cp_spring_temp$allRRhigh["0.5"],
        cp_spring_precip$allRRhigh["0.5"],
        cp_spring_wind$allRRhigh["0.5"],
        cp_spring_bird$allRRhigh["0.5"]
      )
) %>%
  mutate(`OR (95% CI)` = sprintf("%.2f (%.2f, %.2f)", OR, CI_low, CI_high)) %>%
  select(Predictor, `OR (95% CI)`) %>%
  gt() %>%
  tab_header(
    title = md("**Case-Crossover Model: Cumulative Odds Ratios**"),
    subtitle = "Per 0.5 SD Increase"
  ) %>%
  cols_label(`OR (95% CI)` = "Odds Ratio (95% Confidence Interval)") %>%
  tab_options(
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    data_row.padding = px(6)
  )

# ----------------------------
# Plotting Functions
# ----------------------------
plot_cumulative <- function(cp, title) {
  plot(cp, type = "cumulative", var = 0.5, ci = "area",
       col = "black", ci.arg = list(col = rgb(0,0,0,0.1), border = NA),
       lwd = 1.5, main = title, xlab = "Lag (weeks)", ylab = "OR (95% CI)", las = 1)
  abline(h = 1, lty = 2, col = "gray40")
}

plot_slices <- function(cp, title) {
  plot(cp, type = "slices", var = 0.5, ci = "area",
       col = "black", ci.arg = list(col = rgb(0,0,0,0.1), border = NA),
       lwd = 1.3, main = title, xlab = "Lag (weeks)", ylab = "OR (95% CI)", las = 1)
  abline(h = 1, lty = 2, col = "gray40")
}

# ----------------------------
# Save Cumulative Plot
# ----------------------------
png(file.path(figures_folder,"figure_cumulative_ORs_casecrossover_spring.png"), width = 11, height = 7, units = "in", res = 300)

par(
  mfrow = c(2, 4),
  mar = c(4.2, 4.2, 2.5, 1),   # inner margin
  oma = c(1, 1, 0, 1),         # outer margin — removed top title
  cex.main = 1.2,              # plot title text size
  cex.lab = 1.2,               # axis label size
  cex.axis = 1.1,              # axis tick label size
  tcl = -0.3, mgp = c(2.5, 0.7, 0)
)

plot_cumulative <- function(cp, title) {
  plot(cp,
       type = "cumulative",
       var = 0.5,
       ci = "area",
       col = "black",
       ci.arg = list(col = rgb(0, 0, 0, 0.1), border = NA),
       lwd = 1.7,
       main = title,
       xlab = "Lag (weeks)",
       ylab = "OR (95% CI)",
       las = 1)
  abline(h = 1, lty = 2, col = "gray40", lwd = 1)
}

plot_cumulative(cp_spring_runoff, "Surface Runoff")
plot_cumulative(cp_spring_snow, "Snow Density")
plot_cumulative(cp_spring_soil, "Soil Moisture")
plot_cumulative(cp_spring_temp, "Temperature")
plot_cumulative(cp_spring_precip, "Precipitation")
plot_cumulative(cp_spring_wind, "Wind Speed")
plot_cumulative(cp_spring_bird, "Total Bird Abundance")

# ----------------------------
# Save Slices Plot
# ----------------------------
png(file.path(figures_folder,"figure_slice_ORs_casecrossover_spring.png"), width = 11, height = 7, units = "in", res = 300)

par(
  mfrow = c(2, 4),
  mar = c(4.2, 4.2, 2.5, 1),   # inner margin
  oma = c(1, 1, 0, 1),         # outer margin — removed top title
  cex.main = 1.2,              # plot title text size
  cex.lab = 1.2,               # axis label size
  cex.axis = 1.1,              # axis tick label size
  tcl = -0.3, mgp = c(2.5, 0.7, 0)
)

plot_slices(cp_spring_slice_runoff, "Surface Runoff")
plot_slices(cp_spring_slice_snow, "Snow Density")
plot_slices(cp_spring_slice_soil, "Soil Moisture")
plot_slices(cp_spring_slice_temp, "Temperature")
plot_slices(cp_spring_slice_precip, "Precipitation")
plot_slices(cp_spring_slice_wind, "Wind Speed")
plot_slices(cp_spring_slice_bird, "Total Bird Abundance")

dev.off()

```


## Lag Specific Odds Ratio Table (Casecrossover Model)
```{r, lag specific odds ratio table}
# ----------------------------
# Extract Lag-Specific ORs (Wide)
# ----------------------------
extract_lag_ORs_wide <- function(cp_obj, varname, varval = "0.5", lags = 0:4) {
  lag_labels <- paste0("lag", lags)
  or    <- cp_obj$matRRfit[varval, lag_labels]
  low   <- cp_obj$matRRlow[varval, lag_labels]
  high  <- cp_obj$matRRhigh[varval, lag_labels]  # FIXED HERE
  tibble(
    Predictor = varname,
    !!!setNames(as.list(or),   paste0("OR_Lag", lags)),
    !!!setNames(as.list(low),  paste0("Low_Lag", lags)),
    !!!setNames(as.list(high), paste0("High_Lag", lags)),
    !!!setNames(as.list(sprintf("%.2f (%.2f, %.2f)", or, low, high)), paste0("Lag ", lags))
  )
}


# ----------------------------
# Create Lag-Specific Table
# ----------------------------
table_lag_ORs <- bind_rows(
  extract_lag_ORs_wide(cp_slice_runoff, "Surface Runoff"),
  extract_lag_ORs_wide(cp_slice_snow, "Snow Density"),
  extract_lag_ORs_wide(cp_slice_soil, "Soil Moisture"),
  extract_lag_ORs_wide(cp_slice_temp, "Temperature"),
  extract_lag_ORs_wide(cp_slice_precip, "Precipitation"),
  extract_lag_ORs_wide(cp_slice_wind, "Wind Speed"),
  extract_lag_ORs_wide(cp_slice_bird, "Total Bird Abundance")
)



# Highlight significant rows
lags <- 0:4
highlight_matrix <- sapply(lags, function(i) {
  table_lag_ORs[[paste0("Low_Lag", i)]] > 1 | table_lag_ORs[[paste0("High_Lag", i)]] < 1
})
colnames(highlight_matrix) <- paste0("Lag ", lags)

# Export to Word
ft <- table_lag_ORs %>%
  select(Predictor, paste0("Lag ", lags)) %>%
  flextable() %>%
  set_header_labels(Predictor = "Predictor") %>%
  add_header_row(values = c("Predictor", "Odds Ratio (95% CI)"), colwidths = c(1, length(lags))) %>%
  fontsize(size = 11, part = "all") %>%
  autofit() %>%
  align(align = "center", part = "all") %>%
  theme_booktabs()

for (i in lags) {
  ft <- bold(ft, i = which(highlight_matrix[, paste0("Lag ", i)]), j = paste0("Lag ", i))
}

doc <- read_docx() %>%
  body_add_flextable(ft) %>%
  body_add_par(
    "Table 1: Lag-Specific Odds Ratios for Case-Crossover Study on the Association between Environmental Conditions and Highly Pathogenic Avian Influenza Outbreaks in Minnesota, 2022. Estimates are per 0.5 standard deviation increase in each predictor. Statistically significant odds ratios are shown in bold.",
    style = "Normal"
  )

print(doc, target = file.path(tables_folder, "Table_LagSpecific_OR_HPAI_Minnesota.docx"))

ft

```


## Case-Crossover Model with Flexible Crossbasis

```{r, casecrossover flex model}

# ----------------------------
# Model Fitting
# ----------------------------
final_model_flex <- clogit(
  outbreak_binary ~ 
    cb_flex_runoff + cb_flex_snow_density + cb_flex_soil_moisture + cb_flex_temperature +
    cb_flex_precipitation + cb_flex_wind_speed + cb_flex_total_bird_abundance +
    strata(stratum_id),
  method = "efron",
  data = case_crossover_df
)

summary(final_model_flex)
AIC(final_model_flex)
saveRDS(final_model_flex, file.path(objects_folder, "casecrossover_flexible_model.RDS"))

```

```{r, crosspred objects for flex model}
# ----------------------------
# Crosspred Objects
# ----------------------------
cp_flex__runoff       <- crosspred(cb_flex_runoff, final_model_flex, cen = 0, at = 0.5, cumul = TRUE)
cp_flex__snow         <- crosspred(cb_flex_snow_density, final_model_flex, cen = 0, at = 0.5, cumul = TRUE)
cp_flex__soil         <- crosspred(cb_flex_soil_moisture, final_model_flex, cen = 0, at = 0.5, cumul = TRUE)
cp_flex__temp         <- crosspred(cb_flex_temperature, final_model_flex, cen = 0, at = 0.5, cumul = TRUE)
cp_flex__precip       <- crosspred(cb_flex_precipitation, final_model_flex, cen = 0, at = 0.5, cumul = TRUE)
cp_flex__wind         <- crosspred(cb_flex_wind_speed, final_model_flex, cen = 0, at = 0.5, cumul = TRUE)
cp_flex__bird         <- crosspred(cb_flex_total_bird_abundance, final_model_flex, cen = 0, at = 0.5, cumul = TRUE)

cp_flex__slice_runoff <- crosspred(cb_flex_runoff, final_model_flex, cen = 0, at = 0.5)
cp_flex__slice_snow   <- crosspred(cb_flex_snow_density, final_model_flex, cen = 0, at = 0.5)
cp_flex__slice_soil   <- crosspred(cb_flex_soil_moisture, final_model_flex, cen = 0, at = 0.5)
cp_flex__slice_temp   <- crosspred(cb_flex_temperature, final_model_flex, cen = 0, at = 0.5)
cp_flex__slice_precip <- crosspred(cb_flex_precipitation, final_model_flex, cen = 0, at = 0.5)
cp_flex__slice_wind   <- crosspred(cb_flex_wind_speed, final_model_flex, cen = 0, at = 0.5)
cp_flex__slice_bird   <- crosspred(cb_flex_total_bird_abundance, final_model_flex, cen = 0, at = 0.5)

```

## Casecrossover Plots
```{r, plots casecrossover flex}
# ----------------------------
# Cumulative OR Summary Table
# ----------------------------
cumulative_summary <- tibble(
  Predictor = c("Surface Runoff", "Snow Density", "Soil Moisture", "Temperature",
                "Precipitation", "Wind Speed", "Total Bird Abundance"),
      OR = c(
        cp_flex__runoff$allRRfit["0.5"],
        cp_flex__snow$allRRfit["0.5"],
        cp_flex__soil$allRRfit["0.5"],
        cp_flex__temp$allRRfit["0.5"],
        cp_flex__precip$allRRfit["0.5"],
        cp_flex__wind$allRRfit["0.5"],
        cp_flex__bird$allRRfit["0.5"]
      ),
      CI_low = c(
        cp_flex__runoff$allRRlow["0.5"],
        cp_flex__snow$allRRlow["0.5"],
        cp_flex__soil$allRRlow["0.5"],
        cp_flex__temp$allRRlow["0.5"],
        cp_flex__precip$allRRlow["0.5"],
        cp_flex__wind$allRRlow["0.5"],
        cp_flex__bird$allRRlow["0.5"]
      ),
      CI_high = c(
        cp_flex__runoff$allRRhigh["0.5"],
        cp_flex__snow$allRRhigh["0.5"],
        cp_flex__soil$allRRhigh["0.5"],
        cp_flex__temp$allRRhigh["0.5"],
        cp_flex__precip$allRRhigh["0.5"],
        cp_flex__wind$allRRhigh["0.5"],
        cp_flex__bird$allRRhigh["0.5"]
      )
) %>%
  mutate(`OR (95% CI)` = sprintf("%.2f (%.2f, %.2f)", OR, CI_low, CI_high)) %>%
  select(Predictor, `OR (95% CI)`) %>%
  gt() %>%
  tab_header(
    title = md("**Case-Crossover Model: Cumulative Odds Ratios**"),
    subtitle = "Per 0.5 SD Increase"
  ) %>%
  cols_label(`OR (95% CI)` = "Odds Ratio (95% Confidence Interval)") %>%
  tab_options(
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 14,
    data_row.padding = px(6)
  )

# ----------------------------
# Plotting Functions
# ----------------------------
plot_cumulative <- function(cp_flex_, title) {
  plot(cp_flex_, type = "cumulative", var = 0.5, ci = "area",
       col = "black", ci.arg = list(col = rgb(0,0,0,0.1), border = NA),
       lwd = 1.5, main = title, xlab = "Lag (weeks)", ylab = "OR (95% CI)", las = 1)
  abline(h = 1, lty = 2, col = "gray40")
}

plot_slices <- function(cp_flex_, title) {
  plot(cp_flex_, type = "slices", var = 0.5, ci = "area",
       col = "black", ci.arg = list(col = rgb(0,0,0,0.1), border = NA),
       lwd = 1.3, main = title, xlab = "Lag (weeks)", ylab = "OR (95% CI)", las = 1)
  abline(h = 1, lty = 2, col = "gray40")
}

# ----------------------------
# Save Cumulative Plot
# ----------------------------
png(file.path(figures_folder,"figure_cumulative_ORs_casecrossover_flexmodel.png"), width = 11, height = 7, units = "in", res = 300)

par(
  mfrow = c(2, 4),
  mar = c(4.2, 4.2, 2.5, 1),   # inner margin
  oma = c(1, 1, 0, 1),         # outer margin — removed top title
  cex.main = 1.2,              # plot title text size
  cex.lab = 1.2,               # axis label size
  cex.axis = 1.1,              # axis tick label size
  tcl = -0.3, mgp = c(2.5, 0.7, 0)
)

plot_cumulative <- function(cp_flex_, title) {
  plot(cp_flex_,
       type = "cumulative",
       var = 0.5,
       ci = "area",
       col = "black",
       ci.arg = list(col = rgb(0, 0, 0, 0.1), border = NA),
       lwd = 1.7,
       main = title,
       xlab = "Lag (weeks)",
       ylab = "OR (95% CI)",
       las = 1)
  abline(h = 1, lty = 2, col = "gray40", lwd = 1)
}

plot_cumulative(cp_flex__runoff, "Surface Runoff")
plot_cumulative(cp_flex__snow, "Snow Density")
plot_cumulative(cp_flex__soil, "Soil Moisture")
plot_cumulative(cp_flex__temp, "Temperature")
plot_cumulative(cp_flex__precip, "Precipitation")
plot_cumulative(cp_flex__wind, "Wind Speed")
plot_cumulative(cp_flex__bird, "Total Bird Abundance")

# ----------------------------
# Save Slices Plot
# ----------------------------
png(file.path(figures_folder,"figure_slice_ORs_casecrossover_flexmodel.png"), width = 11, height = 7, units = "in", res = 300)

par(
  mfrow = c(2, 4),
  mar = c(4.2, 4.2, 2.5, 1),   # inner margin
  oma = c(1, 1, 0, 1),         # outer margin — removed top title
  cex.main = 1.2,              # plot title text size
  cex.lab = 1.2,               # axis label size
  cex.axis = 1.1,              # axis tick label size
  tcl = -0.3, mgp = c(2.5, 0.7, 0)
)

plot_slices(cp_flex__slice_runoff, "Surface Runoff")
plot_slices(cp_flex__slice_snow, "Snow Density")
plot_slices(cp_flex__slice_soil, "Soil Moisture")
plot_slices(cp_flex__slice_temp, "Temperature")
plot_slices(cp_flex__slice_precip, "Precipitation")
plot_slices(cp_flex__slice_wind, "Wind Speed")
plot_slices(cp_flex__slice_bird, "Total Bird Abundance")

dev.off()

```


## Lag Specific Odds Ratio Table (Casecrossover Model)
```{r, lag specific odds ratio table for flex model}
# ----------------------------
# Extract Lag-Specific ORs (Wide)
# ----------------------------
extract_lag_ORs_wide <- function(cp_flex__obj, varname, varval = "0.5", lags = 0:4) {
  lag_labels <- paste0("lag", lags)
  or    <- cp_flex__obj$matRRfit[varval, lag_labels]
  low   <- cp_flex__obj$matRRlow[varval, lag_labels]
  high  <- cp_flex__obj$matRRhigh[varval, lag_labels]  # FIXED HERE
  tibble(
    Predictor = varname,
    !!!setNames(as.list(or),   paste0("OR_Lag", lags)),
    !!!setNames(as.list(low),  paste0("Low_Lag", lags)),
    !!!setNames(as.list(high), paste0("High_Lag", lags)),
    !!!setNames(as.list(sprintf("%.2f (%.2f, %.2f)", or, low, high)), paste0("Lag ", lags))
  )
}


# ----------------------------
# Create Lag-Specific Table
# ----------------------------
table_lag_ORs <- bind_rows(
  extract_lag_ORs_wide(cp_flex__slice_runoff, "Surface Runoff"),
  extract_lag_ORs_wide(cp_flex__slice_snow, "Snow Density"),
  extract_lag_ORs_wide(cp_flex__slice_soil, "Soil Moisture"),
  extract_lag_ORs_wide(cp_flex__slice_temp, "Temperature"),
  extract_lag_ORs_wide(cp_flex__slice_precip, "Precipitation"),
  extract_lag_ORs_wide(cp_flex__slice_wind, "Wind Speed"),
  extract_lag_ORs_wide(cp_flex__slice_bird, "Total Bird Abundance")
)



# Highlight significant rows
lags <- 0:4
highlight_matrix <- sapply(lags, function(i) {
  table_lag_ORs[[paste0("Low_Lag", i)]] > 1 | table_lag_ORs[[paste0("High_Lag", i)]] < 1
})
colnames(highlight_matrix) <- paste0("Lag ", lags)

# Export to Word
ft <- table_lag_ORs %>%
  select(Predictor, paste0("Lag ", lags)) %>%
  flextable() %>%
  set_header_labels(Predictor = "Predictor") %>%
  add_header_row(values = c("Predictor", "Odds Ratio (95% CI)"), colwidths = c(1, length(lags))) %>%
  fontsize(size = 11, part = "all") %>%
  autofit() %>%
  align(align = "center", part = "all") %>%
  theme_booktabs()

for (i in lags) {
  ft <- bold(ft, i = which(highlight_matrix[, paste0("Lag ", i)]), j = paste0("Lag ", i))
}

doc <- read_docx() %>%
  body_add_flextable(ft) %>%
  body_add_par(
    "Table 1: Lag-Specific Odds Ratios for Case-Crossover Study on the Association between Environmental Conditions and Highly Pathogenic Avian Influenza Outbreaks in Minnesota, 2022. Estimates are per 0.5 standard deviation increase in each predictor. Statistically significant odds ratios are shown in bold.",
    style = "Normal"
  )

print(doc, target = file.path(tables_folder, "Table_LagSpecific_OR_HPAI_Minnesota_flexmodel.docx"))

ft

```

